################################################################################
# Makefile for Vivado Simulation
################################################################################

# ==== Top Level Module for Simulation ==== #
TB_TOP := example_top_tb

# ==== Source Files ==== #
# VHDL source files (*.vhd, *.vhdl); Accepts vhdl 2008 files as well
SOURCES_VHDL := ../../src/hdl/example_top.vhd  \
                ../../src/hdl/example_and.vhd

# Verilog and SystemVerilog files (*.v, *.vh, *.sv, *.svh)
SOURCES_SV   := 

# Xilinx IP source files and IP generation files(*.xci, *.tcl)
SOURCES_IP   := ../../src/ip/c_counter_binary_0.xci \
				../../src/ip/c_counter_binary_1.xci \
				../../src/ip/c_addsub_0.tcl

# Xilinx IP-Integrator Block Diagram (IPI-BD) generation files(*.tcl)
SOURCES_BD   :=	../../src/bd/mblaze_bd.tcl \
				../../src/bd/or_bd.tcl


# ==== Elaboration Options ====
# ELAB_OPTS := -generic_top "P1=10"

# ==== Compile Options ==== #
COMP_OPTS_VHDL := --incr --relax --2008
COMP_OPTS_SV   := --incr --relax 


################################################################################
# Make Rules
################################################################################

# ==== Help ==== #
.PHONY : help
help : 
	@echo "=== Vivado Simulator Make Interface ==="
	@echo "Options:"
	@echo "    make help  - This menu"
	@echo "    make sim   - Simulate design"
	@echo "    make wave  - Simulate design and open the Vivado waveform viewer GUI"
	@echo "    make elab  - Elaborate design"
	@echo "    make comp  - Compile design"
	@echo "    make clean - Delete files generated by Vivado and this build system"

# ==== Simulate ==== #
# Open Waveform in the Vivado GUI 
.PHONY : wave
wave : $(TB_TOP)_snapshot.wdb
	@echo
	@echo "### OPENING WAVES ###"
	xsim --gui $(TB_TOP)_snapshot.wdb

# Simulate without the GUI 
$(TB_TOP)_snapshot.wdb : .elab.timestamp
	@echo
	@echo "### RUNNING SIMULATION ###"
	xsim $(TB_TOP)_snapshot --tclbatch xsim_cfg.tcl

# Phony rule the user can call for simulating w/o the gui
.PHONY : sim
sim : $(TB_TOP)_snapshot.wdb


# ==== Elaborate ==== #
# Phony rule the user can run to elaborate
.PHONY : elab
elab : .elab.timestamp

# Elaborate the compiled object files 
.elab.timestamp : .comp_sv.timestamp .comp_vhdl.timestamp
	@echo
	@echo "### ELABORATING ###"
	xelab -debug all -top $(TB_TOP) -snapshot $(TB_TOP)_snapshot
	touch .elab.timestamp



# ==== Compile ==== #
# Phony rule that the user can run to compile
.PHONY : comp
comp : .comp_sv.timestamp  .comp_vhdl.timestamp

# Compile Verilog / SystemVerilog
ifeq ($(SOURCES_SV),)
.comp_sv.timestamp :
	@echo
	@echo "### NO VERILOG SOURCES GIVEN ###"
	@echo "### SKIPPING VERILOG COMPILATION ###"
	touch .comp_sv.timestamp
else
.comp_sv.timestamp : $(SOURCES_SV)
	@echo
	@echo "### COMPILING SYSTEMVERILOG ###"
	xvlog --sv $(COMP_OPTS_SV) $(DEFINES_SV) $(SOURCES_SV)
	touch .comp_sv.timestamp
endif

# Compile VHDL
ifeq ($(SOURCES_VHDL),)
.comp_vhdl.timestamp :
	@echo
	@echo "### NO VHDL SOURCES GIVEN ###"
	@echo "### SKIPPING VHDL COMPILATION ###"
	touch .comp_vhdl.timestamp
else
.comp_vhdl.timestamp : $(SOURCES_VHDL)
	@echo
	@echo "### COMPILING VHDL ###"
	xvhdl $(COMP_OPTS_VHDL) $(SOURCES_VHDL)
	touch .comp_vhdl.timestamp
endif


# ==== Clean ==== #
.PHONY : clean
clean :
	@rm -rf *.jou *.log *.pb *.wdb xsim.dir .Xil *.str  # This deletes all files generated by Vivado
	@rm -rf .*.timestamp                          # This deletes all our timestamps
	@echo
	@echo "### CLEANED WORKSPACE ###"